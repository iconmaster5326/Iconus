<html>
<head>
<script>
	function newUUID() {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
			var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
	}
	
	conn = new WebSocket("ws://" + location.host);
	conn.onopen = function(event) {
		var input = document.getElementById("consoleInput");
		input.removeAttribute("disabled");
		input.focus();
	};
</script>
</head>
<body>
	<h1>Iconus</h1>
	<p id="content">
		&gt; <input id="consoleInput" type="text" disabled/>
	</p>

	<script>
		var input = document.getElementById("consoleInput");
		var content = document.getElementById("content");

		function register() {
			input.addEventListener("keyup", function(event) {
				event.preventDefault();
				if (event.keyCode === 13) {
					var iif = "eval "+newUUID()+" "+window.btoa(input.value)+"\n";
					console.log("SENDING: "+iif)
					conn.send(iif);
					
					input.replaceWith(input.value);

					var result = document.createElement("p");
					result.setAttribute("id","output");
					result.innerHTML = "...";
					content.appendChild(result);
					
					conn.onmessage = function(event2) {
						console.log("GOT: " + event2.data);
						result.innerHTML = window.atob(event2.data.split(" ")[2]);

						content.appendChild(document.createTextNode("> "));

						input = document.createElement("input");
						input.setAttribute("id", "consoleInput");
						input.setAttribute("type", "text");
						content.appendChild(input);

						input.focus();
						register();
					};
				}
			});
		}
		register();
	</script>
</body>
</html>
