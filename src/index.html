<html>
<head>
<script>
	function newUUID() {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
			var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
	}
	
	conn = new WebSocket("ws://" + location.host);
	conn.onopen = function(event) {
		var input = document.getElementById("consoleInput");
		input.removeAttribute("disabled");
		input.focus();
	};
	
	resultHandlers = {};
	conn.onmessage = function(event) {
		console.log("GOT: " + event.data);
		var message = JSON.parse(event.data);
		
		if (message.type == "result") {
			if (resultHandlers[message.tag]) {
				console.log("Calling handler for result " + message.tag);
				resultHandlers[message.tag](message.result);
				delete resultHandlers[message.tag];
			} else {
				console.log("WARNING: got result but tag not registered: " + message.tag);
			}
		} else {
			console.log("WARNING: unknown message type " + message.type);
		}
	};
</script>
</head>
<body>
	<h1>Iconus</h1>
	<p id="content">
		&gt; <input id="consoleInput" type="text" disabled/>
	</p>

	<script>
		var input = document.getElementById("consoleInput");
		var content = document.getElementById("content");

		function register() {
			input.addEventListener("keyup", function(event) {
				event.preventDefault();
				
				if (event.keyCode === 13) {
					var tag = newUUID();
					
					input.replaceWith(input.value);

					var result = document.createElement("p");
					result.setAttribute("id","output");
					result.innerHTML = "...";
					content.appendChild(result);
					
					resultHandlers[tag] = function(toRender) {
						result.innerHTML = toRender;
					};
					
					var message = JSON.stringify({
						"type": "eval",
						"tag": tag,
						"command": input.value
					});
					console.log("SENDING: "+message)
					conn.send(message);
					
					content.appendChild(document.createTextNode("> "));
					
					input = document.createElement("input");
					input.setAttribute("id", "consoleInput");
					input.setAttribute("type", "text");
					content.appendChild(input);
					
					input.focus();
					register();
				}
			});
		}
		register();
	</script>
</body>
</html>
