<script>
	function onSystemOutputLoad(id, imgElem) {
		var elem = imgElem.parentElement;
		elem.removeChild(imgElem);
		
		var getSpinner = function() {
			return $(elem).find("#spinner").get()[0];
		}
		
		var getPre = function() {
			return $(elem).find("pre").get()[0];
		}
		
		var getInput = function() {
			return $(elem).find("#systemInput").get()[0];
		}
		
		messageHandlers[id] = function(message) {
			if (message.done) {
				elem.replaceChild(document.createTextNode("(process exited with code "+message.code+")"), getSpinner());
				elem.removeChild(getInput());
				delete messageHandlers[id];
			} else if (message.error) {
				var div = document.createElement("div");
				div.setAttribute("style", "color: red;");
				div.innerHTML = "<b>error:</b> "+message.error;
				elem.replaceChild(div, getPre());
				elem.removeChild(getSpinner());
				elem.removeChild(getInput());
				delete messageHandlers[id];
			} else {
				var div = document.createElement("div");
				if (message.stderr) {
					div.setAttribute("style", "color: red;");
				}
				
				div.appendChild(document.createTextNode(message.text+"\n"));
				getPre().appendChild(div);
			}
		};
		
		getInput().addEventListener("keyup", function(event) {
			event.preventDefault();
			if (event.keyCode === 13) {
				var message = JSON.stringify({
					"type": "message",
					"tag": id,
					"input": getInput().value+"\n"
				});
				console.log("SENDING: "+message);
				conn.send(message);
				getInput().value = "";
			}
		});
	}
</script>
